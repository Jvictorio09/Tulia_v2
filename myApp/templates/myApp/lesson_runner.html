{% extends 'myApp/base.html' %}

{% block title %}Lesson ¬∑ Module {{ module.code }}{% endblock %}

{% block content %}
<div id="lessonRunnerApp" class="min-h-screen pb-28 bg-ink-bg">
    <header class="sticky top-0 z-30 bg-ink-bg/95 backdrop-blur border-b border-default">
        <div class="max-w-5xl mx-auto px-4 sm:px-6 py-4 flex flex-col gap-4">
        <div class="flex items-center justify-between gap-3">
                <a href="{% url 'home' %}" class="w-10 h-10 rounded-xl border border-default bg-overlay-weak hover:bg-overlay-strong transition grid place-items-center" aria-label="Back to home">
                    <svg class="w-5 h-5 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
                <div class="flex-1 min-w-0 text-center">
                    <h1 class="text-sm sm:text-base font-heading font-bold text-text-strong truncate">Module {{ module.code }} ¬∑ {{ module.name }}</h1>
                    <p class="text-xs text-muted" id="sessionLoopLabel">Loop 1 ¬∑ Main</p>
                            </div>
                <div class="flex items-center gap-2 text-xs font-semibold">
                    {% if profile.current_streak > 0 %}
                    <span class="hidden sm:inline-flex items-center gap-1 px-2 py-1 rounded-full border border-amber-500/40 bg-amber-500/10 text-amber-500">
                        <span>üî•</span><span>{{ profile.current_streak }}</span>
                    </span>
                        {% endif %}
                    <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full border border-default bg-overlay-weak text-muted">
                        <span>‚ö°</span><span>{{ profile.total_xp }}</span>
                    </span>
                    </div>
                    </div>
            <div class="flex items-center justify-between text-xs text-muted">
                <div class="flex items-center gap-2">
                    <span id="stakesScoreChip" class="hidden items-center gap-1 px-2 py-1 rounded-full border border-default bg-overlay-weak text-[11px] font-semibold"></span>
                    <span id="leverChoiceChip" class="hidden items-center gap-1 px-2 py-1 rounded-full border border-default bg-overlay-weak text-[11px] font-semibold"></span>
                    </div>
                <button id="coachToggleButton" type="button" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-electric-violet/30 bg-electric-violet/10 text-electric-violet font-semibold hover:bg-electric-violet/15 transition focus:outline-none focus:ring-2 focus:ring-brand">
                    <span>Coach</span>
                    <span class="w-6 h-6 rounded-full bg-gradient-to-br from-electric-violet to-cyan text-white grid place-items-center text-xs font-bold">AI</span>
                </button>
                </div>
            <div>
                <div class="w-full h-1 rounded-full bg-overlay-weak overflow-hidden">
                    <div id="progressFill" class="h-full bg-gradient-to-r from-electric-violet to-cyan transition-all duration-500" style="width: 0%;"></div>
            </div>
                <div id="stageRail" class="mt-2 grid grid-cols-6 gap-2 text-[11px] font-semibold text-muted"></div>
            </div>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 sm:px-6">
        {% if seed_error %}
        <div class="mt-10 p-6 rounded-2xl border border-rose-400/40 bg-rose-500/10 text-rose-100">
            <h2 class="text-lg font-heading font-semibold mb-2">Content Unavailable</h2>
            <p class="text-sm leading-relaxed">{{ seed_error }}</p>
            <p class="text-xs mt-3 opacity-80">Our team has already been alerted. Please retry in a moment.</p>
        </div>
        {% else %}
        <section id="cardRegion" class="mt-8 space-y-6" aria-live="polite"></section>

        <div id="cardActions" class="fixed inset-x-0 pointer-events-none bottom-[6.5rem] z-[60]" style="padding-bottom: env(safe-area-inset-bottom)">
            <div class="max-w-xl mx-auto px-4 sm:px-6 pointer-events-auto">
                <div class="rounded-2xl border border-default bg-ink-surface shadow-xl shadow-black/10 px-4 py-3 flex items-center gap-3">
                    <button id="cardSkipButton" type="button" class="hidden px-4 py-2 rounded-lg border border-default text-muted hover:text-text-strong hover:bg-overlay-weak transition focus:outline-none focus:ring-2 focus:ring-brand">Skip</button>
                    <div id="timeboxHint" class="flex-1 text-center text-xs text-muted"></div>
                    <button id="cardSubmitButton" type="button" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-gradient-to-r from-electric-violet to-cyan text-white font-semibold shadow-lg shadow-electric-violet/40 hover:shadow-electric-violet/60 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand">
                            <span>Continue</span>
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        </button>
                </div>
                </div>
            </div>
        {% endif %}
    </main>

    <aside id="coachDrawer" class="fixed inset-x-0 bottom-0 sm:inset-y-auto sm:top-24 sm:bottom-24 sm:right-8 sm:left-auto z-40 w-full sm:max-w-md transform translate-y-full sm:translate-y-0 sm:translate-x-full transition-transform duration-300 ease-out">
        <div class="mx-auto flex h-[min(90vh,_32rem)] w-full flex-col rounded-t-3xl border border-default border-b-0 bg-ink-surface shadow-2xl sm:mx-0 sm:h-[calc(100vh-12rem)] sm:rounded-l-3xl sm:rounded-t-none sm:border-b sm:border-l sm:border-r-0">
            <div class="flex items-center justify-between px-4 sm:px-8 py-4 border-b border-default">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-muted">Coach Tuli</p>
                    <h2 id="coachTitle" class="text-lg font-heading font-semibold text-text-strong">Gentle guidance</h2>
                    <p id="coachSubtitle" class="text-xs text-muted mt-0.5">Stage-specific nudges appear here</p>
                </div>
                <button id="coachCloseButton" type="button" class="w-9 h-9 rounded-full border border-default bg-overlay-weak hover:bg-overlay-strong transition focus:outline-none focus:ring-2 focus:ring-brand" aria-label="Close coach drawer">
                    <svg class="w-4 h-4 mx-auto text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div id="coachContent" class="flex-1 overflow-y-auto px-4 sm:px-6 py-6 space-y-4"></div>
            <div id="coachComposer" class="border-t border-default bg-ink-surface/95 backdrop-blur-sm px-4 sm:px-6 py-4">
                <div id="coachPromptChips" class="mb-3 flex flex-wrap gap-2"></div>
                <form id="coachForm" class="flex items-end gap-3">
                    <label class="sr-only" for="coachInput">Ask Coach Tuli</label>
                    <textarea id="coachInput" rows="1" class="flex-1 resize-none rounded-2xl border border-default bg-overlay-weak px-4 py-3 text-sm leading-snug text-text-strong placeholder:text-muted focus:border-electric-violet focus:outline-none focus:ring-2 focus:ring-electric-violet/40 transition" placeholder="Ask Coach Tuli for guidance..." autocomplete="off"></textarea>
                    <button id="coachSendButton" type="submit" class="inline-flex shrink-0 items-center gap-2 rounded-2xl bg-gradient-to-r from-electric-violet to-cyan px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-electric-violet/40 hover:shadow-electric-violet/60 transition focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand disabled:cursor-not-allowed disabled:opacity-60">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4l16 8-16 8v-5l10-3-10-3V4z"/>
                        </svg>
                        <span>Send</span>
                    </button>
                </form>
            </div>
        </div>
    </aside>

    <div id="toastContainer" class="fixed top-4 left-1/2 -translate-x-1/2 z-[100] space-y-3 w-full max-w-sm pointer-events-none"></div>
                        </div>
{% endblock %}

{% block extra_js %}
{{ lesson_cards|json_script:"lesson-cards" }}
{{ session_state|json_script:"lesson-session" }}
{{ flow_meta|json_script:"lesson-flow-meta" }}
{{ progress_payload|json_script:"lesson-progress" }}
{{ ui_tokens|json_script:"lesson-ui-tokens" }}
{{ module.code|json_script:"lesson-module-code" }}
<script>
(() => {
    const cardsEl = document.getElementById('lesson-cards');
    const sessionEl = document.getElementById('lesson-session');
    const flowEl = document.getElementById('lesson-flow-meta');
    const progressEl = document.getElementById('lesson-progress');
    const tokensEl = document.getElementById('lesson-ui-tokens');
    const moduleEl = document.getElementById('lesson-module-code');

    const lessonCards = cardsEl ? JSON.parse(cardsEl.textContent || '[]') : [];
    const sessionState = sessionEl ? JSON.parse(sessionEl.textContent || '{}') : {};
    const flowMeta = flowEl ? JSON.parse(flowEl.textContent || '{}') : {};
    const progressPayload = progressEl ? JSON.parse(progressEl.textContent || '{}') : {};
    const uiTokens = tokensEl ? JSON.parse(tokensEl.textContent || '{}') : {};
    const moduleCode = moduleEl ? JSON.parse(moduleEl.textContent || '""') : '';

    if (!Array.isArray(lessonCards)) return;

    const endpoints = {
        submit: "{% url 'lesson_card_submit' %}",
        spacing: "{% url 'lesson_spacing_schedule' %}",
        coach: "{% url 'ai_coach_respond' %}",
    };

    const csrfToken = (() => {
        const name = 'csrftoken=';
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name)) {
                return decodeURIComponent(cookie.substring(name.length));
            }
        }
        return '';
    })();

    const formatNumber = (value, digits = 0) => {
        const number = Number(value);
        if (Number.isNaN(number)) return '0';
        return number.toLocaleString(undefined, { maximumFractionDigits: digits });
    };

    const showToast = (message, tone = 'info') => {
        if (!message) return;
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `pointer-events-auto px-4 py-3 rounded-xl shadow-lg border text-sm font-semibold tracking-tight ${
            tone === 'success'
                ? 'bg-emerald-500/10 border-emerald-400/40 text-emerald-100'
                : tone === 'error'
                    ? 'bg-rose-500/10 border-rose-400/40 text-rose-100'
                    : 'bg-ink-surface border-default text-text-strong'
        }`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('opacity-0', 'translate-y-2');
            setTimeout(() => toast.remove(), 300);
        }, 2600);
    };

    const formatOption = (value = '') => value.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());

    const escapeHtml = (value = '') =>
        value
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

    const PHASE_LOOKUP = {
        A: { key: 'learn', label: 'Learn' },
        B: { key: 'diagnose', label: 'Diagnose' },
        C: { key: 'regulate', label: 'Regulate' },
        D: { key: 'decide', label: 'Decide' },
        E: { key: 'map', label: 'Map' },
        F: { key: 'reflect', label: 'Reflect' },
    };

    const COACH_PROMPTS = {
        learn: [
            'What‚Äôs the headline for this moment, in your own words?',
            'What signals tell you this situation matters?',
            'What would success look like when this moment is over?',
        ],
        diagnose: [
            'What feels most at stake right now‚Äîpressure, visibility, or irreversibility?',
            'Where could things break down if you do nothing?',
            'What early signal would tell you pressure is rising?',
        ],
        regulate: [
            'What helps you reset when the stakes feel high?',
            'How is your energy or focus showing up right now?',
            'What quick ritual steadies you before you move?',
        ],
        decide: [
            'What narrow decision needs to be made next?',
            'Which lever gives you the most control here?',
            'What would ‚Äúgood enough‚Äù look like for this next move?',
        ],
        map: [
            'What‚Äôs one concrete action you can capture for later?',
            'Who else needs to be in the loop, and why?',
            'Which detail should you make sure to note for future you?',
        ],
        reflect: [
            'What surprised you about this loop?',
            'What did you try that‚Äôs worth repeating next time?',
            'Where did you feel momentum‚Äîor friction?',
        ],
        default: [
            'What feels unclear about this moment?',
            'Where do you want the coach to focus?',
            'What‚Äôs the next question on your mind?',
        ],
    };

    const CARD_RENDERERS = {
        ScenarioTaggerCard(card) {
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            const props = card.props || {};
            const selected = new Map();
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Diagnose ¬∑ Spot the Heat</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">What signals pressure here?</h2>
                        <p class="text-sm text-muted leading-relaxed">${props.scenario_text || 'Review the scenario and tag the stakes you notice.'}</p>
                    </header>
                    <section class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            ${['pressure', 'visibility', 'irreversibility'].map((key) => `
                                <label class="flex items-center gap-3 px-4 py-3 border border-default rounded-xl bg-overlay-weak hover:border-electric-violet/60 focus-within:ring-2 focus-within:ring-brand transition">
                                    <input type="checkbox" value="${key}" class="selection-toggle" />
                                    <span class="text-sm font-semibold text-text-strong">${formatOption(key)}</span>
                    </label>
                            `).join('')}
                        </div>
                        <div class="space-y-2">
                            <span class="text-xs uppercase tracking-[0.2em] text-muted">Overall heat</span>
                            <div class="flex gap-3">
                                ${['high', 'medium', 'low', 'not_sure'].map((level) => `
                                    <label class="inline-flex items-center gap-2 px-3 py-2 border border-default rounded-lg focus-within:ring-2 focus-within:ring-brand">
                                        <input type="radio" name="classification" value="${level}" />
                                        <span class="text-sm text-text-strong">${formatOption(level)}</span>
                    </label>
                                `).join('')}
                </div>
            </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Observation</label>
                            <textarea name="reflection" rows="3" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Anything else you notice about the stakes?"></textarea>
        </div>
                    </section>
                </article>
            `;

            const checkboxes = wrapper.querySelectorAll('.selection-toggle');
            checkboxes.forEach((box) => {
                box.addEventListener('change', () => {
                    selected.set(box.value, box.checked);
                });
            });

            const collect = () => {
                const classification = wrapper.querySelector('input[name="classification"]:checked')?.value || null;
                const reflection = wrapper.querySelector('textarea[name="reflection"]')?.value.trim() || '';
                const tags = Array.from(selected.entries()).filter(([, checked]) => checked).map(([key]) => key);
                if (!tags.length) {
                    throw new Error('Select at least one stakes signal to continue.');
                }
                if (!classification) {
                    throw new Error('Choose how intense this moment feels overall.');
                }
                const answerKey = props.answer_key || {};
                let accuracy = 0;
                const total = Object.keys(answerKey).length || tags.length;
                if (total > 0) {
                    const correct = tags.filter((key) => Boolean(answerKey[key])).length;
                    accuracy = correct / total;
                }
                return {
                    payload: {
                        selected_tags: tags,
                        classification,
                        reflection,
                    },
                    metrics: {
                        completion: true,
                        accuracy,
                        reflection: Boolean(reflection),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        PersonalScenarioCapture(card) {
            const props = card.props || {};
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Capture ¬∑ Your moment</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Log the high-stakes moment you're facing next</h2>
                        <p class="text-sm text-muted">Write a short headline and rate the pressure, visibility, and irreversibility.</p>
                    </header>
                    <section class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Moment headline</label>
                            <textarea name="situation_text" rows="3" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="${props.helper_text || 'What‚Äôs the next moment that feels the heat?'}"></textarea>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm text-text-strong">
                            ${['pressure', 'visibility', 'irreversibility'].map((dimension) => `
                                <label class="flex flex-col gap-2 px-4 py-3 border border-default rounded-2xl bg-overlay-weak focus-within:ring-2 focus-within:ring-brand">
                                    <span class="text-xs uppercase tracking-[0.2em] text-muted">${formatOption(dimension)}</span>
                                    <select name="${dimension}" class="bg-transparent border-none focus:outline-none">
                                        ${(props.rating_scale || ['low', 'medium', 'high']).map((level) => `
                                            <option value="${level}">${formatOption(level)}</option>
                                        `).join('')}
                                    </select>
                        </label>
                            `).join('')}
                    </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">One-line intention (optional)</label>
                            <input type="text" name="reflection" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Why this moment matters right now" />
                </div>
                    </section>
                </article>
            `;

            const collect = () => {
                const text = wrapper.querySelector('textarea[name="situation_text"]')?.value.trim() || '';
                if (!text) {
                    throw new Error('Give your moment a short description before continuing.');
                }
                const ratings = ['pressure', 'visibility', 'irreversibility'].reduce((acc, key) => {
                    acc[key] = wrapper.querySelector(`select[name="${key}"]`)?.value || 'low';
                    return acc;
                }, {});
                const reflection = wrapper.querySelector('input[name="reflection"]')?.value.trim() || '';
                return {
                    payload: {
                        situation_text: text,
                        ...ratings,
                        reflection,
                    },
                    metrics: {
                        completion: true,
                        accuracy: 1,
                        reflection: Boolean(reflection),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        TernaryRatingCard(card) {
            const props = card.props || {};
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Quantify ¬∑ PIC Rating</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Give that moment a quick PIC score</h2>
                        <p class="text-sm text-muted">Rate Pressure, Irreversibility, and Control from 1‚Äì5.</p>
                    </header>
                    <section class="space-y-4">
                        ${['P', 'I', 'C'].map((key) => `
                            <div class="space-y-2">
                                <div class="flex items-center justify-between text-xs text-muted">
                                    <span>${props.explainers?.[key] || key}</span>
                                    <span id="metricValue-${key}" class="text-text-strong font-semibold">3</span>
                        </div>
                                <input type="range" name="${key}" min="1" max="5" value="3" class="w-full accent-electric-violet" />
                        </div>
                        `).join('')}
                        <p class="text-xs text-muted">
                            Stakes score = (Pressure + Irreversibility) √∑ Control
                            <span id="stakeScorePreview" class="ml-2 inline-flex items-center gap-1 px-2 py-1 rounded-full border border-default bg-overlay-weak text-[11px] font-semibold text-electric-violet">1.00</span>
                        </p>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Reflection (optional)</label>
                            <textarea name="reflection" rows="3" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="What stands out about this PIC snapshot?"></textarea>
                        </div>
                    </section>
                </article>
            `;

            const controls = ['P', 'I', 'C'].map((key) => wrapper.querySelector(`input[name="${key}"]`));
            const labels = ['P', 'I', 'C'].map((key) => wrapper.querySelector(`#metricValue-${key}`));
            const scorePreview = wrapper.querySelector('#stakeScorePreview');

            const updatePreview = () => {
                const values = controls.map((input) => Number(input.value || 1));
                labels.forEach((label, idx) => {
                    label.textContent = values[idx];
                });
                const [p, i, c] = values;
                const score = ((p + i) / Math.max(1, c));
                scorePreview.textContent = score.toFixed(2);
                return score;
            };

            controls.forEach((input) => {
                input.addEventListener('input', updatePreview);
            });
            let stakesScore = updatePreview();

            const collect = () => {
                const reflection = wrapper.querySelector('textarea[name="reflection"]')?.value.trim() || '';
                stakesScore = updatePreview();
                const payload = {};
                controls.forEach((input) => {
                    payload[input.name] = Number(input.value || 1);
                });
                payload.stakes_score = stakesScore;
                payload.reflection = reflection;
                return {
                    payload,
                    metrics: {
                        completion: true,
                        accuracy: stakesScore >= 4 ? 1 : (stakesScore >= 2 ? 0.6 : 0.3),
                        reflection: Boolean(reflection),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        SingleSelectActionCard(card) {
            const props = card.props || {};
            const actions = props.actions || [];
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Choose ¬∑ Control Shift</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Pick the move you'll test this round</h2>
                        <p class="text-sm text-muted">Select one lever-based action. You can always add your own.</p>
                    </header>
                    <section class="space-y-4">
                        <div class="space-y-2">
                            ${actions.map((action, idx) => `
                                <label class="flex items-start gap-3 px-4 py-3 border border-default rounded-2xl bg-overlay-weak hover:border-electric-violet/60 transition focus-within:ring-2 focus-within:ring-brand">
                                    <input type="radio" name="selected_action" value="${action.key}" class="mt-1.5" ${idx === 0 ? 'checked' : ''}/>
                                    <div class="space-y-1">
                                        <p class="text-sm font-semibold text-text-strong">${action.label}</p>
                                        <p class="text-xs text-muted">${action.desc || ''}</p>
                    </div>
                    </label>
                            `).join('')}
                            ${props.allow_other ? `
                                <label class="flex items-start gap-3 px-4 py-3 border border-dashed border-default rounded-2xl bg-transparent hover:border-electric-violet/60 transition focus-within:ring-2 focus-within:ring-brand">
                                    <input type="radio" name="selected_action" value="other" class="mt-1.5"/>
                                    <div class="flex-1 space-y-1">
                                        <p class="text-sm font-semibold text-text-strong">Something else</p>
                                        <input type="text" name="custom_action" class="w-full mt-1 px-3 py-2 border border-default rounded-xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Describe your move" />
                </div>
                    </label>
                            ` : ''}
            </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Reflection (optional)</label>
                            <textarea name="reflection" rows="3" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Why this lever shift matters for the scenario?"></textarea>
        </div>
                    </section>
                </article>
            `;

            const collect = () => {
                const selected = wrapper.querySelector('input[name="selected_action"]:checked')?.value || '';
                let actionKey = selected;
                let customText = '';
                if (selected === 'other') {
                    customText = wrapper.querySelector('input[name="custom_action"]')?.value.trim() || '';
                    if (!customText) {
                        throw new Error('Describe your custom action to continue.');
                    }
                }
                if (!actionKey) {
                    throw new Error('Select the action you want to test.');
                }
                const reflection = wrapper.querySelector('textarea[name="reflection"]')?.value.trim() || '';
                return {
                    payload: {
                        scenario_ref: props.scenario_ref || null,
                        selected_action: actionKey,
                        custom_action: customText,
                        reflection,
                    },
                    metrics: {
                        completion: true,
                        accuracy: 1,
                        reflection: Boolean(reflection),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        MantraSelectOrWrite(card) {
            const props = card.props || {};
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            const groupedMantras = (props.mantras || []).reduce((acc, mantra) => {
                acc[mantra.tone || 'neutral'] = acc[mantra.tone || 'neutral'] || [];
                acc[mantra.tone || 'neutral'].push(mantra);
                return acc;
            }, {});
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Reframe ¬∑ Mantra</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Pick or write a mantra that grounds you</h2>
                        <p class="text-sm text-muted">You can pick one from the list or create your own line (max ${props.character_limit || 120} characters).</p>
                    </header>
                    <section class="space-y-4">
                        <div class="space-y-4" role="radiogroup" aria-label="Prewritten mantras">
                            ${Object.entries(groupedMantras).map(([tone, items]) => `
                                <div class="space-y-2">
                                    <p class="text-xs uppercase tracking-[0.2em] text-muted">${formatOption(tone)}</p>
                                    <div class="space-y-2">
                                        ${items.map((mantra, idx) => `
                                            <label class="flex items-start gap-3 px-4 py-3 border border-default rounded-2xl bg-overlay-weak hover:border-electric-violet/60 transition focus-within:ring-2 focus-within:ring-brand">
                                                <input type="radio" name="mantra_choice" value="${mantra.id}" class="mt-1.5" ${idx === 0 ? 'checked' : ''}/>
                                                <span class="text-sm leading-relaxed text-text-strong">${mantra.text}</span>
                </label>
                                        `).join('')}
            </div>
        </div>
                            `).join('')}
                </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Or write your own</label>
                            <textarea name="custom_mantra" rows="3" maxlength="${props.character_limit || 120}" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Write your custom mantra"></textarea>
                            <p class="text-xs text-muted">Leave blank to use a prewritten mantra. Coach tip: ${props.coach_tip || 'Pick a line that calms your nervous system before you speak.'}</p>
            </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Reflection (optional)</label>
                            <textarea name="reflection" rows="2" class="w-full px-4 py-2 border border-default rounded-xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="What makes this mantra a fit?"></textarea>
        </div>
                    </section>
                </article>
            `;

            const collect = () => {
                const selected = wrapper.querySelector('input[name="mantra_choice"]:checked')?.value || '';
                const custom = wrapper.querySelector('textarea[name="custom_mantra"]')?.value.trim() || '';
                const reflection = wrapper.querySelector('textarea[name="reflection"]')?.value.trim() || '';
                if (!selected && !custom) {
                    throw new Error('Pick a mantra or write your own before continuing.');
                }
                return {
                    payload: {
                        selected_id: selected || null,
                        custom_text: custom,
                        reflection,
                    },
                    metrics: {
                        completion: true,
                        accuracy: 1,
                        reflection: Boolean(reflection),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        GuidedBreathDrill(card) {
            const props = card.props || {};
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            const steps = props.script?.steps || [
                'Inhale through the nose for two counts.',
                'Hold softly for one count.',
                'Exhale through the mouth for four counts.',
            ];
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Regulate ¬∑ Micro Drill</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Take ${props.timings?.duration_s || 30}s to reset your body</h2>
                        <p class="text-sm text-muted">${props.baseline_prompt || 'Notice where tension sits, breathe through this short drill, and log the shift.'}</p>
                    </header>
                    <section class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <label class="flex flex-col gap-2 px-4 py-3 border border-default rounded-2xl bg-overlay-weak focus-within:ring-2 focus-within:ring-brand">
                                <span class="text-xs uppercase tracking-[0.2em] text-muted">Before</span>
                                <select name="baseline_state" class="bg-transparent border-none focus:outline-none text-sm text-text-strong">
                                    <option value="steady">Steady</option>
                                    <option value="slight">Slight tension</option>
                                    <option value="tense">Very tense</option>
                                </select>
                            </label>
                            <label class="flex flex-col gap-2 px-4 py-3 border border-default rounded-2xl bg-overlay-weak focus-within:ring-2 focus-within:ring-brand">
                                <span class="text-xs uppercase tracking-[0.2em] text-muted">After</span>
                                <select name="post_state" class="bg-transparent border-none focus:outline-none text-sm text-text-strong">
                                    <option value="steady">Steady</option>
                                    <option value="lighter">Lighter</option>
                                    <option value="doing_ok">Still working</option>
                                </select>
                            </label>
    </div>
                        <div class="space-y-2">
                            <p class="text-xs uppercase tracking-[0.2em] text-muted">Guided steps</p>
                            <ol class="space-y-2 text-sm text-text-strong">
                                ${steps.map((step) => `<li class="px-3 py-2 rounded-xl border border-default bg-overlay-weak">${step}</li>`).join('')}
                            </ol>
</div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">One-word anchor (optional)</label>
                            <input type="text" name="anchor_word" class="w-full px-4 py-2 border border-default rounded-xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Centered, steady, ready..." />
                </div>
                    </section>
                </article>
            `;

            const collect = () => {
                const baseline = wrapper.querySelector('select[name="baseline_state"]')?.value || 'steady';
                const post = wrapper.querySelector('select[name="post_state"]')?.value || 'steady';
                const anchor = wrapper.querySelector('input[name="anchor_word"]')?.value.trim() || '';
                return {
                    payload: {
                        baseline_state: baseline,
                        post_state: post,
                        anchor_word: anchor,
                        duration_s: props.timings?.duration_s || 30,
                    },
                    metrics: {
                        completion: true,
                        accuracy: 1,
                        reflection: Boolean(anchor),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        BinaryClassifierCard(card) {
            const props = card.props || {};
            const examples = props.examples || [];
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Diagnose ¬∑ Load Lab</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Label each moment as emotional or cognitive load</h2>
                        <p class="text-sm text-muted">Tap the load type that best matches the cue.</p>
                    </header>
                    <section class="space-y-3">
                        ${examples.map((item, idx) => `
                            <fieldset class="p-4 rounded-2xl border border-default bg-overlay-weak space-y-3">
                                <legend class="text-sm text-text-strong font-semibold">Example ${idx + 1}</legend>
                                <p class="text-sm text-muted leading-relaxed">${item.text}</p>
                                <div class="flex items-center gap-3 text-sm text-text-strong">
                                    ${['emotional', 'cognitive', 'not_sure'].map((option) => `
                                        <label class="inline-flex items-center gap-2 px-3 py-2 border border-default rounded-lg focus-within:ring-2 focus-within:ring-brand">
                                            <input type="radio" name="example_${item.id}" value="${option}" />
                                            <span>${formatOption(option)}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </fieldset>
                        `).join('')}
                    </section>
                </article>
            `;

            const collect = () => {
                const responses = [];
                let correct = 0;
                examples.forEach((item) => {
                    const value = wrapper.querySelector(`input[name="example_${item.id}"]:checked`)?.value || null;
                    if (!value) {
                        throw new Error('Label each example before continuing.');
                    }
                    if (item.correct && value === item.correct) {
                        correct += 1;
                    }
                    responses.push({
                        id: item.id,
                        selection: value,
                        correct: item.correct,
                    });
                });
                const accuracy = examples.length ? correct / examples.length : 1;
                return {
                    payload: { responses },
                    metrics: {
                        completion: true,
                        accuracy,
                        reflection: false,
                    },
                };
            };

            return { form: wrapper, collect };
        },

        PickThreeKeyPoints(card) {
            const props = card.props || {};
            const options = props.options || [];
            const correctIds = new Set(props.correct_ids || []);
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Clarify ¬∑ Pick Three</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Choose the three lines that best carry this message</h2>
                        <p class="text-sm text-muted">${props.source_paragraph || 'Select exactly three options that keep the signal sharp.'}</p>
                    </header>
                    <section class="space-y-3">
                        ${options.map((option) => `
                            <label class="flex items-start gap-3 px-4 py-3 border border-default rounded-2xl bg-overlay-weak hover:border-electric-violet/60 transition focus-within:ring-2 focus-within:ring-brand">
                                <input type="checkbox" value="${option.id}" class="mt-1.5 selection-toggle"/>
                                <span class="text-sm text-text-strong leading-relaxed">${option.text}</span>
                            </label>
                        `).join('')}
                    </section>
                    ${props.free_text_enabled ? `
                    <section class="space-y-2">
                        <label class="text-xs uppercase tracking-[0.2em] text-muted">Want to pitch your own lines?</label>
                        <textarea name="free_text" rows="2" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Optional: add your own phrasing"></textarea>
                    </section>
                    ` : ''}
                </article>
            `;

            const maxSelect = 3;
            const checkboxes = wrapper.querySelectorAll('.selection-toggle');
            checkboxes.forEach((box) => {
                box.addEventListener('change', () => {
                    const checked = Array.from(checkboxes).filter((input) => input.checked);
                    if (checked.length > maxSelect) {
                        box.checked = false;
                        showToast(`Choose only ${maxSelect} options.`, 'info');
                    }
                });
            });

            const collect = () => {
                const selectedIds = Array.from(checkboxes).filter((input) => input.checked).map((input) => input.value);
                if (selectedIds.length !== maxSelect) {
                    throw new Error(`Pick exactly ${maxSelect} options to continue.`);
                }
                const correctCount = selectedIds.filter((id) => correctIds.has(id)).length;
                const freeText = wrapper.querySelector('textarea[name="free_text"]')?.value.trim() || '';
                return {
                    payload: {
                        selected_ids: selectedIds,
                        correct_count: correctCount,
                        free_text,
                    },
                    metrics: {
                        completion: true,
                        accuracy: maxSelect ? correctCount / maxSelect : 1,
                        reflection: Boolean(freeText),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        LeverSelector3P(card) {
            const props = card.props || {};
            const leverCards = props.lever_cards || [];
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';

            const leverOptions = leverCards.map((lever) => {
                const checkedAttr = props.last_choice === lever.id ? 'checked' : '';
                const exampleItems = (lever.examples || [])
                    .map((example) => '<li>' + example + '</li>')
                    .join('');
                return [
                    '<label class="flex flex-col gap-3 px-4 py-4 border border-default rounded-2xl bg-overlay-weak hover:border-electric-violet/60 transition focus-within:ring-2 focus-within:ring-brand">',
                    '    <div class="flex items-center justify-between gap-3">',
                    '        <span class="text-sm font-semibold text-text-strong">' + formatOption(lever.id) + '</span>',
                    '        <input type="radio" name="selected_lever" value="' + lever.id + '" ' + checkedAttr + ' />',
                    '    </div>',
                    '    <p class="text-xs text-muted leading-relaxed">' + (lever.desc || '') + '</p>',
                    '    <ul class="text-xs text-muted space-y-1 list-disc list-inside">' + exampleItems + '</ul>',
                    '</label>',
                ].join('');
            }).join('');

            wrapper.innerHTML = [
                '<article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">',
                '    <header class="space-y-2">',
                '        <p class="text-xs uppercase tracking-[0.3em] text-muted">Decide ¬∑ Pick your lever</p>',
                '        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Which lever unlocks the most momentum right now?</h2>',
                '        <p class="text-sm text-muted">Pick Preparation, Presence, or Perspective‚Äîthen note why.</p>',
                '    </header>',
                '    <section class="grid grid-cols-1 sm:grid-cols-3 gap-3">',
                leverOptions,
                '    </section>',
                '    <section class="space-y-2">',
                '        <label class="text-xs uppercase tracking-[0.2em] text-muted">What makes this lever the move?</label>',
                '        <textarea name="reflection" rows="3" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Tie it back to your scenario."></textarea>',
                '    </section>',
                '</article>',
            ].join('');

            const collect = () => {
                const selected = wrapper.querySelector('input[name="selected_lever"]:checked')?.value || '';
                if (!selected) {
                    throw new Error('Pick a lever to continue.');
                }
                const reflection = wrapper.querySelector('textarea[name="reflection"]')?.value.trim() || '';
                return {
                    payload: {
                        scenario_ref: props.scenario_ref || null,
                        selected_lever: selected,
                        reflection,
                    },
                    metrics: {
                        completion: true,
                        accuracy: 1,
                        reflection: Boolean(reflection),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        PresenceRitualQuickStart(card) {
            const props = card.props || {};
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Presence ¬∑ Quick Ritual</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Drop into your presence ritual (${props.duration_s || 30}s)</h2>
                        <p class="text-sm text-muted">Follow the steps, then log how ready you feel.</p>
                    </header>
                    <section class="space-y-4">
                        <ol class="space-y-2 text-sm text-text-strong">
                            ${(Array.isArray(props.script) ? props.script : props.script?.steps || []).map((step) => `<li class="px-3 py-2 rounded-xl border border-default bg-overlay-weak">${step}</li>`).join('')}
                        </ol>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <label class="flex flex-col gap-2 px-4 py-3 border border-default rounded-2xl bg-overlay-weak focus-within:ring-2 focus-within:ring-brand">
                                <span class="text-xs uppercase tracking-[0.2em] text-muted">Readiness now</span>
                                <select name="readiness_state" class="bg-transparent border-none focus:outline-none text-sm text-text-strong">
                                    <option value="primed">Primed</option>
                                    <option value="steady">Steady</option>
                                    <option value="warming_up">Warming up</option>
                                </select>
                            </label>
                            <label class="flex flex-col gap-2 px-4 py-3 border border-default rounded-2xl bg-overlay-weak focus-within:ring-2 focus-within:ring-brand">
                                <span class="text-xs uppercase tracking-[0.2em] text-muted">Intention word</span>
                                <input type="text" name="intention_word" class="bg-transparent border-none focus:outline-none text-sm text-text-strong placeholder:text-muted" placeholder="${props.intention_prompt || 'Anchoring word'}" />
                            </label>
                        </div>
                    </section>
                </article>
            `;

            const collect = () => {
                const readiness = wrapper.querySelector('select[name="readiness_state"]')?.value || 'primed';
                const intention = wrapper.querySelector('input[name="intention_word"]')?.value.trim() || '';
                return {
                    payload: {
                        readiness_state: readiness,
                        intention_word: intention,
                        duration_s: props.duration_s || 30,
                    },
                    metrics: {
                        completion: true,
                        accuracy: 1,
                        reflection: Boolean(intention),
                    },
                };
            };

            return { form: wrapper, collect };
        },

        StakesMapBuilder(card) {
            const props = card.props || {};
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Map ¬∑ Stakes Map</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">Build your stakes map in five quick fields</h2>
                        <p class="text-sm text-muted">Capture the situation, pressure points, trigger, lever, and next action.</p>
                    </header>
                    <section class="space-y-4">
                        <label class="space-y-2">
                            <span class="text-xs uppercase tracking-[0.2em] text-muted">Situation headline</span>
                            <input type="text" name="situation" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="Board update on margin strategy" />
                        </label>
                        <div class="space-y-2">
                            <span class="text-xs uppercase tracking-[0.2em] text-muted">Pressure points (pick up to 2)</span>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                ${(props.pressure_options || []).map((option) => `
                                    <label class="flex items-center gap-2 px-4 py-3 border border-default rounded-2xl bg-overlay-weak hover:border-electric-violet/60 focus-within:ring-2 focus-within:ring-brand">
                                        <input type="checkbox" value="${option}" class="pressure-toggle"/>
                                        <span class="text-sm text-text-strong">${option}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Trigger cue</label>
                            <select name="trigger" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong focus:outline-none focus:ring-2 focus:ring-brand">
                                ${(props.trigger_examples || []).map((trigger) => `<option value="${trigger}">${trigger}</option>`).join('')}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Lever to pull</label>
                            <select name="lever" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong focus:outline-none focus:ring-2 focus:ring-brand">
                                ${(props.lever_cards || []).map((lever) => `<option value="${lever.id}">${formatOption(lever.id)}</option>`).join('')}
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Next action</label>
                            <textarea name="action_step" rows="3" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="${(props.action_hints || [])[0] || 'One sentence describing what you will do'}"></textarea>
                        </div>
                    </section>
                </article>
            `;

            const pressureToggles = wrapper.querySelectorAll('.pressure-toggle');
            pressureToggles.forEach((toggle) => {
                toggle.addEventListener('change', () => {
                    const checked = Array.from(pressureToggles).filter((input) => input.checked);
                    if (checked.length > 2) {
                        toggle.checked = false;
                        showToast('Choose at most two pressure points.', 'info');
                    }
                });
            });

            const collect = () => {
                const situation = wrapper.querySelector('input[name="situation"]')?.value.trim() || '';
                if (!situation) {
                    throw new Error('Add a short headline for the situation.');
                }
                const pressurePoints = Array.from(pressureToggles).filter((input) => input.checked).map((input) => input.value);
                if (!pressurePoints.length) {
                    throw new Error('Pick at least one pressure point.');
                }
                const trigger = wrapper.querySelector('select[name="trigger"]')?.value || '';
                const lever = wrapper.querySelector('select[name="lever"]')?.value || '';
                const actionStep = wrapper.querySelector('textarea[name="action_step"]')?.value.trim() || '';
                if (!actionStep) {
                    throw new Error('Describe the next action to lock the stakes map.');
                }
                return {
                    payload: {
                        situation,
                        pressure_points: pressurePoints,
                        trigger,
                        lever,
                        action_step: actionStep,
                    },
                    metrics: {
                        completion: true,
                        accuracy: 1,
                        reflection: true,
                    },
                };
            };

            return { form: wrapper, collect };
        },

        ReflectionRatingCard(card) {
            const props = card.props || {};
            const wrapper = document.createElement('form');
            wrapper.className = 'space-y-6';
            wrapper.innerHTML = `
                <article class="p-6 sm:p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/5 space-y-6">
                    <header class="space-y-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-muted">Reflect ¬∑ Progress Check</p>
                        <h2 class="text-xl sm:text-2xl font-heading font-bold text-text-strong">How helpful was this loop?</h2>
                        <p class="text-sm text-muted">Rate the helpfulness from 1‚Äì5 and jot a quick reflection.</p>
                    </header>
                    <section class="space-y-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Helpfulness</label>
                            <input type="range" name="helpfulness_rating" min="1" max="5" value="4" class="accent-electric-violet" />
                            <div class="flex items-center justify-between text-xs text-muted">
                                <span>1 ¬∑ Not helpful</span>
                                <span id="helpfulnessValue" class="font-semibold text-text-strong">4</span>
                                <span>5 ¬∑ Very helpful</span>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs uppercase tracking-[0.2em] text-muted">Reflection</label>
                            <textarea name="reflection" rows="3" class="w-full px-4 py-3 border border-default rounded-2xl bg-overlay-weak text-sm text-text-strong placeholder:text-muted focus:outline-none focus:ring-2 focus:ring-brand" placeholder="What shifted for you after this arc?"></textarea>
                        </div>
                    </section>
                </article>
            `;

            const slider = wrapper.querySelector('input[name="helpfulness_rating"]');
            const valueLabel = wrapper.querySelector('#helpfulnessValue');
            slider.addEventListener('input', () => {
                valueLabel.textContent = slider.value;
            });

            const collect = () => {
                const rating = Number(slider.value || 4);
                const reflection = wrapper.querySelector('textarea[name="reflection"]')?.value.trim() || '';
                if (!reflection) {
                    throw new Error('Add a short reflection to capture the insight.');
                }
                return {
                    payload: {
                        helpfulness_rating: rating,
                        reflection,
                    },
                    metrics: {
                        completion: true,
                        accuracy: rating / 5,
                        reflection: true,
                    },
                };
            };

            return { form: wrapper, collect };
        },

        CoachSheetTip(card) {
            const props = card.props || {};
            const wrapper = document.createElement('div');
            wrapper.className = 'p-6 sm:p-8 rounded-3xl border border-dashed border-default bg-ink-surface/70 text-center space-y-3';
            wrapper.innerHTML = `
                <h2 class="text-lg font-heading font-semibold text-text-strong">${props.title || 'Coach tip'}</h2>
                <p class="text-sm text-muted">${props.body || 'Taking a quick beat‚Äîyour next card is almost ready.'}</p>
                ${Array.isArray(props.details) && props.details.length ? `
                    <ul class="text-xs text-muted space-y-1">
                        ${props.details.map((detail) => `<li>${detail}</li>`).join('')}
                    </ul>
                ` : ''}
            `;

            const collect = () => ({
                payload: {},
                metrics: { completion: true, accuracy: 1, reflection: false },
            });

            return { form: wrapper, collect };
        },
    };

    class LessonRunnerApp {
        constructor(config) {
            this.cards = config.cards.slice();
            this.sessionState = { ...(config.session || {}) };
            this.flow = config.flow || {};
            this.progress = config.progress || {};
            this.moduleCode = config.moduleCode;
            this.csrfToken = config.csrfToken;
            this.endpoints = config.endpoints;
            this.mount = document.getElementById('cardRegion');
            this.skipButton = document.getElementById('cardSkipButton');
            this.submitButton = document.getElementById('cardSubmitButton');
            this.timeboxHint = document.getElementById('timeboxHint');
            this.progressFill = document.getElementById('progressFill');
            this.stageRail = document.getElementById('stageRail');
            this.loopLabel = document.getElementById('sessionLoopLabel');
            this.scoreChip = document.getElementById('stakesScoreChip');
            this.leverChip = document.getElementById('leverChoiceChip');
            this.coachButton = document.getElementById('coachToggleButton');
            this.coachDrawer = document.getElementById('coachDrawer');
            this.coachClose = document.getElementById('coachCloseButton');
            this.coachContent = document.getElementById('coachContent');
            this.coachTitle = document.getElementById('coachTitle');
            this.coachSubtitle = document.getElementById('coachSubtitle');
            this.coachPromptChips = document.getElementById('coachPromptChips');
            this.coachForm = document.getElementById('coachForm');
            this.coachInput = document.getElementById('coachInput');
            this.coachSendButton = document.getElementById('coachSendButton');

            this.currentStart = performance.now();
            this.completedCount = this.sessionState.completed_cards ? this.sessionState.completed_cards.length : 0;
            this.initialTotal = this.cards.length + this.completedCount;
            this.currentCard = null;
            this.currentCollector = null;
            this.busy = false;
            this.coachFeed = null;
            this.coachConversation = [];
            this.currentPhaseKey = null;

            this.bindEvents();
            this.renderRail();
            this.renderHeaderChips();
            this.renderCurrentCard();
        }

        bindEvents() {
            this.submitButton.addEventListener('click', () => this.handleSubmit());
            this.skipButton.addEventListener('click', () => this.handleSkip());
            this.coachButton.addEventListener('click', () => this.toggleCoach(true));
            this.coachClose.addEventListener('click', () => this.toggleCoach(false));
            if (this.coachForm) {
                this.coachForm.addEventListener('submit', (evt) => {
                    evt.preventDefault();
                    this.handleCoachSubmit();
                });
            }
            if (this.coachPromptChips) {
                this.coachPromptChips.addEventListener('click', (evt) => {
                    const button = evt.target.closest('button[data-prompt]');
                    if (!button) return;
                    evt.preventDefault();
                    this.useCoachPrompt(button.dataset.prompt || '');
                });
            }
            if (this.coachInput) {
                const autoSize = () => this.autoSizeCoachInput();
                this.coachInput.addEventListener('input', autoSize);
                autoSize();
                this.coachInput.addEventListener('keydown', (evt) => {
                    if (evt.key === 'Enter' && !evt.shiftKey) {
                        evt.preventDefault();
                        this.handleCoachSubmit();
                    }
                });
            }
            document.addEventListener('keydown', (evt) => {
                if (evt.key === 'Escape') this.toggleCoach(false);
            });
        }

        renderRail() {
            if (!this.stageRail) return;
            const segments = ['Learn', 'Diagnose', 'Regulate', 'Decide', 'Map', 'Reflect'];
            this.stageRail.innerHTML = segments.map((label, idx) => {
                const done = idx < Math.min(this.completedCount, segments.length);
                return `<span class="inline-flex items-center justify-center gap-2 px-3 py-1 rounded-full border text-[11px] font-semibold ${
                    done ? 'border-electric-violet/40 bg-electric-violet/10 text-electric-violet' : 'border-default bg-overlay-weak text-muted'
                }">
                    <span class="w-2 h-2 rounded-full ${done ? 'bg-electric-violet' : 'bg-muted'}"></span>${label}
                </span>`;
            }).join('');
        }

        renderHeaderChips() {
            if (this.loopLabel) {
                this.loopLabel.textContent = `Loop ${(this.progress.loop_index || 0) + 1} ¬∑ ${this.progress.pass_type === 'return' ? 'Return' : 'Main'}`;
            }
            if (this.scoreChip) {
                const score = this.sessionState.last_stakes_score;
                if (typeof score === 'number') {
                    this.scoreChip.textContent = `Stakes score ¬∑ ${score.toFixed(2)}`;
                    this.scoreChip.classList.remove('hidden');
                } else {
                    this.scoreChip.classList.add('hidden');
                }
            }
            if (this.leverChip) {
                const lever = this.sessionState.last_lever_choice;
                if (lever) {
                    this.leverChip.textContent = `Lever ¬∑ ${formatOption(lever)}`;
                this.leverChip.classList.remove('hidden');
            } else {
                this.leverChip.classList.add('hidden');
            }
            }
        }

        renderCurrentCard() {
            if (!this.mount) return;
            this.mount.innerHTML = '';
            if (!this.cards.length) {
                const celebration = document.createElement('div');
                celebration.className = 'mt-10 p-8 rounded-3xl border border-default bg-ink-surface shadow-xl shadow-black/10 text-center space-y-3';
                celebration.innerHTML = `
                    <h2 class="text-2xl font-heading font-bold text-text-strong">Arc complete</h2>
                    <p class="text-sm text-muted">Great work mapping your stakes. Ready for a booster? You can always come back for another loop.</p>
                `;
                this.mount.appendChild(celebration);
                this.submitButton.disabled = true;
                this.submitButton.classList.add('opacity-60', 'cursor-not-allowed');
                this.skipButton.classList.add('hidden');
                return;
            }
            const card = this.cards[0];
            const renderer = CARD_RENDERERS[card.template_id] || CARD_RENDERERS.CoachSheetTip;
            const { form, collect } = renderer(card);
            form.dataset.cardTemplate = card.template_id;
            this.mount.appendChild(form);
            this.currentCard = card;
            this.currentCollector = collect;
            this.currentStart = performance.now();
            this.configureActions(card);
            this.renderCoachCard(card);
            this.updateProgress();
        }

        configureActions(card) {
            if (!this.submitButton || !this.skipButton || !this.timeboxHint) return;
            const timebox = card.props?.timebox_s || card.timebox_s;
            this.timeboxHint.textContent = timebox ? `~${timebox}s focus` : 'Take the time you need';
            const skippable = card.optional === true || card.skippable === true;
            this.skipButton.classList.toggle('hidden', !skippable);
            this.skipButton.disabled = !skippable;
        }

        handleSkip() {
            if (!this.cards.length) return;
            this.cards.shift();
            this.renderCurrentCard();
        }

        async handleSubmit() {
            if (this.busy || !this.currentCollector || !this.currentCard) return;
            let collected;
            try {
                collected = this.currentCollector();
            } catch (err) {
                showToast(err.message || 'Please complete the card before continuing.', 'error');
                return;
            }
            this.busy = true;
            this.submitButton.classList.add('opacity-60', 'cursor-not-allowed');
            const timeOnCard = Math.round(performance.now() - this.currentStart);
            const body = {
                module_code: this.moduleCode,
                card: {
                    template_id: this.currentCard.template_id,
                    exercise_id: this.currentCard.exercise_id,
                    card_key: this.currentCard.card_key,
                },
                payload: collected.payload,
                metrics: collected.metrics,
                time_on_card: timeOnCard,
                client_ts: new Date().toISOString(),
            };
            try {
                const response = await fetch(this.endpoints.submit, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken,
                },
                    body: JSON.stringify(body),
                });
            const data = await response.json();
                if (!data.ok) {
                    throw new Error(data.error?.message || 'Submission failed');
                }
                this.sessionState = data.session_state || this.sessionState;
                this.cards = data.cards || [];
                this.completedCount += 1;
                this.renderRail();
                this.renderHeaderChips();
                if (data.scores?.total) {
                    showToast(`+${data.scores.total} pts`, 'success');
                }
                this.renderCurrentCard();
        } catch (error) {
                console.error(error);
                showToast(error.message || 'Network error. Try again.', 'error');
            } finally {
                this.busy = false;
                this.submitButton.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        }

        updateProgress() {
            const total = this.initialTotal || 1;
            const percent = Math.min(100, (this.completedCount / total) * 100);
            if (this.progressFill) {
                this.progressFill.style.width = `${percent}%`;
            }
        }

        renderCoachCard(card) {
            if (!this.coachContent || !this.coachTitle || !this.coachSubtitle) return;
            const templateName = card.template_id || 'CoachSheetTip';
            const phaseInfo = this.getPhaseInfo(card);
            const phaseKey = phaseInfo.key;
            if (phaseKey !== this.currentPhaseKey) {
                this.coachConversation = [];
            }
            this.currentPhaseKey = phaseKey;
            this.coachContent.innerHTML = '';
            this.coachTitle.textContent = `Coach ¬∑ ${formatOption(templateName.replace(/Card$/, ''))}`;
            const insights = [];
            if (templateName === 'TernaryRatingCard' && typeof this.sessionState.last_stakes_score === 'number') {
                insights.push(`Last stakes score: ${this.sessionState.last_stakes_score.toFixed(2)}`);
            }
            if (templateName === 'LeverSelector3P' && this.sessionState.last_lever_choice) {
                insights.push(`Recent lever: ${formatOption(this.sessionState.last_lever_choice)}`);
            }
            if (insights.length) {
                const insightBlock = document.createElement('div');
                insightBlock.className = 'px-4 py-3 border border-default rounded-2xl bg-overlay-weak';
                insightBlock.innerHTML = `
                    <p class="text-xs uppercase tracking-[0.2em] text-muted mb-1">Recent signals</p>
                    <ul class="text-sm text-text-strong space-y-1 list-disc list-inside">
                        ${insights.map((line) => `<li>${line}</li>`).join('')}
                    </ul>
                `;
                this.coachContent.appendChild(insightBlock);
            }
            const nudge = document.createElement('div');
            nudge.className = 'px-4 py-4 border border-default rounded-2xl bg-overlay-weak space-y-2 text-sm text-muted';
            nudge.textContent = 'Complete the card, capture the reflection, and your progress ring fills automatically.';
            this.coachContent.appendChild(nudge);
            this.coachSubtitle.textContent = `You're in the ${phaseInfo.label} phase`;
            const feed = document.createElement('div');
            feed.dataset.coachFeed = 'true';
            feed.className = 'space-y-3';
            this.coachContent.appendChild(feed);
            this.coachFeed = feed;
            if (this.coachConversation.length) {
                this.coachConversation.forEach((message) => {
                    this.appendCoachMessage(message.role, message.text, message.meta, false);
                });
            }
            this.populateCoachPrompts(phaseKey);
            this.autoSizeCoachInput();
        }

        getPhaseInfo(card) {
            const exerciseId = (card?.exercise_id || '').toString();
            const prefix = exerciseId.charAt(0).toUpperCase();
            const fallback = PHASE_LOOKUP.A;
            const info = PHASE_LOOKUP[prefix] || fallback;
            return { ...info, exerciseId };
        }

        populateCoachPrompts(phaseKey) {
            if (!this.coachPromptChips) return;
            const prompts = COACH_PROMPTS[phaseKey] || COACH_PROMPTS.default;
            this.coachPromptChips.innerHTML = '';
            prompts.forEach((prompt) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.dataset.prompt = prompt;
                button.className =
                    'inline-flex items-center gap-2 rounded-full border border-default bg-overlay-weak px-3 py-1.5 text-xs font-semibold text-muted hover:border-electric-violet/60 hover:text-electric-violet transition focus:outline-none focus:ring-2 focus:ring-brand';
                button.textContent = prompt;
                this.coachPromptChips.appendChild(button);
            });
        }

        useCoachPrompt(prompt) {
            if (!this.coachInput || !prompt) return;
            const trimmed = prompt.trim();
            if (!trimmed) return;
            const existing = this.coachInput.value.trim();
            this.coachInput.value = existing ? `${existing}\n${trimmed}` : trimmed;
            this.autoSizeCoachInput();
            this.coachInput.focus();
            this.coachInput.setSelectionRange(this.coachInput.value.length, this.coachInput.value.length);
        }

        autoSizeCoachInput() {
            if (!this.coachInput) return;
            this.coachInput.style.height = 'auto';
            const maxHeight = 160;
            const nextHeight = Math.min(this.coachInput.scrollHeight, maxHeight);
            this.coachInput.style.height = `${nextHeight}px`;
        }

        appendCoachMessage(role, text, meta = {}, record = true) {
            if (!this.coachContent) return;
            if (!this.coachFeed) {
                const feed = document.createElement('div');
                feed.dataset.coachFeed = 'true';
                feed.className = 'space-y-3';
                this.coachContent.appendChild(feed);
                this.coachFeed = feed;
            }
            const isUser = role === 'user';
            const bubble = document.createElement('div');
            bubble.className = `${isUser
                ? 'ml-auto bg-gradient-to-r from-electric-violet to-cyan text-white shadow-lg shadow-electric-violet/40'
                : 'mr-auto border border-default bg-overlay-weak text-text-strong shadow'} max-w-[85%] rounded-2xl px-4 py-3 text-sm leading-relaxed`;
            bubble.innerHTML = `<p>${escapeHtml(text).replace(/\n/g, '<br>')}</p>`;
            if (Array.isArray(meta.sources) && meta.sources.length) {
                const sources = document.createElement('div');
                sources.className = 'mt-2 flex flex-wrap gap-2';
                meta.sources.forEach((source) => {
                    const chip = document.createElement('span');
                    chip.className = 'inline-flex items-center rounded-full border border-default bg-overlay-weak px-3 py-1 text-[11px] font-semibold uppercase tracking-[0.2em] text-muted';
                    chip.textContent = source;
                    sources.appendChild(chip);
                });
                bubble.appendChild(sources);
            }
            this.coachFeed.appendChild(bubble);
            this.coachContent.scrollTop = this.coachContent.scrollHeight;
            if (record) {
                this.coachConversation.push({ role, text, meta });
            }
        }

        async handleCoachSubmit() {
            if (!this.coachInput || !this.coachSendButton) return;
            const message = this.coachInput.value.trim();
            if (!message) {
                showToast('Ask Coach Tuli something first.', 'error');
                return;
            }
            this.appendCoachMessage('user', message);
            this.coachInput.value = '';
            this.autoSizeCoachInput();
            this.coachSendButton.disabled = true;
            this.coachSendButton.classList.add('opacity-60', 'cursor-not-allowed');
            try {
                const response = await fetch(this.endpoints.coach, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrfToken,
                    },
                    body: JSON.stringify({
                        question: message,
                        module: this.moduleCode,
                    }),
                });
                const payload = await response.json();
                if (!response.ok) {
                    throw new Error(payload?.error || 'Coach is unavailable.');
                }
                const answer =
                    (payload?.answer || '').trim() ||
                    'I‚Äôm here to help‚Äîtry asking about the moment you‚Äôre working through.';
                this.appendCoachMessage('coach', answer, {
                    sources: Array.isArray(payload?.source_chips) ? payload.source_chips : [],
                });
                if (payload?.suggested_drill?.prompt) {
                    this.appendCoachMessage('coach', payload.suggested_drill.prompt, {
                        sources: payload.suggested_drill.chips || [],
                    });
                }
            } catch (error) {
                console.error(error);
                this.appendCoachMessage('coach', 'I hit a snag getting that answer. Try again in a moment.', {}, true);
                showToast(error.message || 'Coach is offline right now.', 'error');
            } finally {
                this.coachSendButton.disabled = false;
                this.coachSendButton.classList.remove('opacity-60', 'cursor-not-allowed');
            }
        }

        toggleCoach(show) {
            if (!this.coachDrawer) return;
            if (show) {
                this.coachDrawer.classList.remove('translate-y-full');
                this.coachDrawer.classList.remove('sm:translate-x-full');
                if (this.coachInput) {
                    setTimeout(() => {
                        this.coachInput.focus();
                        this.autoSizeCoachInput();
                        if (this.coachContent) {
                            this.coachContent.scrollTop = this.coachContent.scrollHeight;
                        }
                    }, 180);
                }
            } else {
                this.coachDrawer.classList.add('translate-y-full');
                this.coachDrawer.classList.add('sm:translate-x-full');
            }
        }
    }

    const lessonApp = new LessonRunnerApp({
        cards: lessonCards,
        session: sessionState,
        flow: flowMeta,
        progress: progressPayload,
        moduleCode,
        csrfToken,
        endpoints,
    });

    window.lessonRunnerApp = lessonApp;
    window.openCoachSheet = function () {
        lessonApp.toggleCoach(true);
    };
    window.closeCoachSheet = function () {
        lessonApp.toggleCoach(false);
    };
})();
</script>
{% endblock %}

