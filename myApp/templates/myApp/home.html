{% extends 'myApp/base.html' %}
{% load app_filters %}

{% block title %}Home - Tulia{% endblock %}

{% block content %}
<div class="space-y-8">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div>
            <h1 class="text-3xl font-heading font-bold text-text-strong">Welcome back, {{ user.username }}!</h1>
            <p class="text-muted max-w-2xl mt-2">Pick a district to continue your practice journey. Each district opens with a story-driven overview, followed by modules, AI coaching, and exercises that unlock new venues.</p>
        </div>
        <div class="flex gap-3">
            <a href="{% url 'ai_chat' %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-white/10 bg-white/5 hover:bg-white/10 transition">
                <span>ðŸ§ </span>
                <span>Open AI Coach</span>
            </a>
            <a href="{% url 'profile' %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-white/10 hover:bg-white/5 transition">
                <span>ðŸ‘¤</span>
                <span>Profile</span>
            </a>
        </div>
    </header>

    <section>
        <div class="flex items-baseline justify-between mb-4">
            <h2 class="text-xl font-semibold text-text-strong">Districts</h2>
            <p class="text-xs text-muted uppercase tracking-widest">Districts â†’ Modules â†’ Exercises â†’ Venues</p>
        </div>
        <div class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
            {% for card in district_cards %}
            <article class="border border-white/10 rounded-2xl p-6 bg-white/5 backdrop-blur">
                <div class="flex items-start justify-between gap-4">
                    <div>
                        <p class="text-sm text-muted uppercase tracking-wide mb-1">District {{ card.district.number }}</p>
                        <h3 class="text-2xl font-heading font-semibold text-text-strong mb-2">{{ card.district.name }}</h3>
                    </div>
                    <span class="px-3 py-1 text-xs font-semibold rounded-full
                        {% if card.status == 'complete' %}bg-emerald-500/20 text-emerald-300
                        {% elif card.status == 'in_progress' %}bg-electric-violet/20 text-electric-violet
                        {% elif card.status == 'available' %}bg-cyan/20 text-cyan
                        {% else %}bg-white/10 text-muted{% endif %}">
                        {{ card.status|title }}
                    </span>
                </div>
                {% if card.district.description %}
                <p class="text-sm text-gray-400 mb-4">{{ card.district.description }}</p>
                {% endif %}

                {% if card.modules %}
                <div class="space-y-3 mb-6">
                    {% for module in card.modules %}
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-sm font-semibold text-text-strong">Module {{ module.code }} Â· {{ module.name }}</p>
                            <p class="text-xs text-muted">
                                {% if module.status == 'complete' %}
                                    Completed â€” venue unlocked
                                {% elif module.status == 'in_progress' %}
                                    In progress â€” resume exercises
                                {% elif module.status == 'available' %}
                                    Ready to start{% if module.unlock_hint %} Â· unlocks {{ module.unlock_hint }}{% endif %}
                                {% else %}
                                    Locked until previous module is complete
                                {% endif %}
                            </p>
                        </div>
                        <span class="text-xs uppercase tracking-wide text-muted">{{ module.status|replace:"_, "|title }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="flex flex-wrap gap-3">
                    <a href="{% url 'district_overview' card.district.number %}"
                       class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-electric-violet text-white font-semibold shadow-lg shadow-electric-violet/40 hover:bg-violet-600 transition">
                        Explore Overview
                    </a>
                    <a href="{% url 'district_venues' card.district.number %}"
                       class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-white/10 hover:bg-white/10 transition {% if not card.base_access and card.status == 'locked' %}opacity-50 pointer-events-none{% endif %}">
                        View Venues
                    </a>
                </div>
            </article>
            {% empty %}
            <div class="border border-dashed border-white/20 rounded-2xl p-8 text-center text-muted">
                No districts configured yet. Please seed data.
            </div>
            {% endfor %}
        </div>
    </section>

    {% if resume_module %}
    <section class="border border-electric-violet/30 rounded-2xl p-6 bg-electric-violet/10 backdrop-blur">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h2 class="text-xl font-heading font-semibold text-text-strong mb-1">Resume Module {{ resume_module.code }}</h2>
                <p class="text-sm text-muted">Jump back into the lesson to finish the learn stage or continue your exercises.</p>
            </div>
            <div class="flex gap-3">
                <a href="{% url 'module_learn' resume_module.code %}" class="px-4 py-2 rounded-lg border border-white/10 hover:bg-white/10 transition">Review Lesson</a>
                <a href="{% url 'module_exercises' resume_module.code %}" class="px-4 py-2 rounded-lg bg-electric-violet text-white font-semibold shadow-lg shadow-electric-violet/40 hover:bg-violet-600 transition">Go to Exercises</a>
            </div>
        </div>
    </section>
    {% endif %}

    <section class="grid gap-6 md:grid-cols-2">
        <div id="daily-quest" class="border border-white/10 rounded-2xl p-6 bg-white/5">
            <h3 class="text-lg font-semibold text-text-strong flex items-center gap-2 mb-3">
                <span>ðŸ“‹</span>
                <span>Daily Quest</span>
            </h3>
            {% if daily_quest and not daily_quest.completed %}
            <p class="text-sm text-gray-300 mb-4">{{ daily_quest.description }}</p>
            <div class="flex gap-4 text-sm font-semibold">
                <span class="text-cyan">+{{ daily_quest.xp_reward }} XP</span>
                <span class="text-amber-400">+{{ daily_quest.coin_reward }} coins</span>
            </div>
            {% else %}
            <p class="text-sm text-muted">All set for today. Come back tomorrow for a new quest.</p>
            {% endif %}
        </div>

        <div class="border border-white/10 rounded-2xl p-6 bg-white/5">
            <h3 class="text-lg font-semibold text-text-strong flex items-center gap-2 mb-3">
                <span>ðŸŽ¯</span>
                <span>Milestone Challenge</span>
            </h3>
            {% if milestone_passed %}
            <p class="text-sm text-emerald-300 mb-2">You passed the Level 1 milestoneâ€”District 1 venues remain open for free exploration.</p>
            <a href="{% url 'district_venues' 1 %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border border-emerald-400/40 text-emerald-200 hover:bg-emerald-500/10 transition">
                Visit District 1 Venues
            </a>
            {% elif all_modules_complete %}
            <p class="text-sm text-muted mb-4">Youâ€™ve completed all modules. Lock in your gains with the milestone assessment.</p>
            <a href="{% url 'milestone' 1 %}" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-amber-500 text-white font-semibold hover:bg-amber-600 transition">
                Take Milestone Challenge
            </a>
            {% else %}
            <p class="text-sm text-muted">Complete all modules in District 1 to unlock the milestone assessment.</p>
            {% endif %}
        </div>
    </section>
</div>
{% endblock %}
