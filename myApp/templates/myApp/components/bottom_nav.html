{% load app_filters %}
<div class="fixed bottom-0 left-0 right-0 z-50 safe-area-bottom" id="bottomNav">
    <!-- Glassy footer bar -->
    <div class="bg-ink-surface/80 backdrop-blur-md border-t border-white/10 h-16 sm:h-18">
        {% with current_level=request.user.profile.current_level|default:1 %}
        <div class="max-w-7xl mx-auto h-full flex items-center justify-around px-2 sm:px-4">
            
            <!-- [A] Districts -->
            <a href="{% url 'home' %}" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'home' or request.resolver_match.url_name == 'district_overview' or request.resolver_match.url_name == 'district_venues' %}active{% endif %}"
               data-tab="districts"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <!-- Streak badge -->
                    {% if user.profile.current_streak > 0 %}
                    <span class="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center text-xs">ðŸ”¥</span>
                    {% endif %}
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">Districts</span>
            </a>
            
            <!-- [B] Venues -->
            <a href="{% url 'district_venues' current_level %}" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'district_venues' or request.resolver_match.url_name == 'venue_detail' %}active{% endif %}"
               data-tab="venues"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 20V6a2 2 0 012-2h8a2 2 0 012 2v14m-6-6h6m-6 4h6m-6-8h6M6 12h.01M6 16h.01M6 8h.01"/>
                    </svg>
                    {% if request.user.profile.tickets > 0 %}
                    <span class="absolute -top-1 -right-1 min-w-[16px] h-4 bg-electric-violet rounded-full flex items-center justify-center text-[8px] font-bold px-1">ðŸŽŸ{{ request.user.profile.tickets }}</span>
                    {% endif %}
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">Venues</span>
            </a>
            
               <!-- [C] Coach (Center Action) -->
               <a href="{% url 'ai_chat' %}" 
                  class="nav-tab coach-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'lesson_runner' or request.resolver_match.url_name == 'ai_chat' %}active{% endif %}"
                  data-tab="coach"
                  onclick="handleCoachTap(this, event); return false;">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-electric-violet to-purple-600 flex items-center justify-center shadow-lg shadow-electric-violet/50 coach-glow">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <!-- AI tip badge -->
                    <span class="absolute -top-1 -right-1 w-4 h-4 bg-cyan rounded-full flex items-center justify-center text-[8px] font-bold coach-badge hidden">ðŸ’¡</span>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5 hidden sm:block">Coach</span>
            </a>
            
            <!-- [D] Daily Quest -->
            <a href="{% url 'home' %}#daily-quest" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out"
               data-tab="quest"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10m-12 8h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    {% if daily_quest and not daily_quest.completed %}
                    <span class="absolute -top-1 -right-1 w-4 h-4 bg-cyan rounded-full flex items-center justify-center text-[8px] font-bold">!</span>
                    {% else %}
                    <span class="absolute -top-1 -right-1 w-4 h-4 rounded-full flex items-center justify-center text-[8px] font-bold badge-neutral">âœ“</span>
                    {% endif %}
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">Daily Quest</span>
            </a>
            
            <!-- [E] Me -->
            <a href="{% url 'profile' %}" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'profile' %}active{% endif %}"
               data-tab="profile"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <!-- New reward dot -->
                    <div class="absolute -top-1 -right-1 w-2 h-2 bg-cyan rounded-full me-dot hidden"></div>
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">Me</span>
            </a>
            
        </div>
        {% endwith %}
    </div>
</div>

<style>
/* Safe area for devices with home indicator */
.safe-area-bottom {
    padding-bottom: env(safe-area-inset-bottom, 0);
}

/* Nav tab states */
.nav-tab {
    color: rgba(107, 114, 128, 0.95); /* gray-500 */
    transform: scale(1);
}

.nav-tab:active {
    transform: scale(0.98);
    transition: transform 120ms;
}

.nav-tab.active {
    color: #8b5cf6; /* electric-violet */
}

.nav-tab.active .nav-icon {
    color: #8b5cf6;
}

.nav-tab.active .nav-indicator {
    display: block;
    animation: slideIn 200ms ease-out;
}

.nav-label {
    color: inherit;
    opacity: 0.7;
}

.nav-tab.active .nav-label {
    opacity: 1;
    color: #8b5cf6;
}

/* Coach center action */
.coach-tab {
    margin-top: -8px;
}

.coach-glow {
    animation: coachPulse 3s ease-in-out infinite;
}

.coach-badge {
    animation: badgePulse 2s ease-in-out infinite;
}

.badge-neutral {
    background: rgba(148, 163, 184, 0.25);
    color: rgba(30, 41, 59, 0.85);
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-50%) scaleX(0);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) scaleX(1);
    }
}

@keyframes coachPulse {
    0%, 100% {
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    }
    50% {
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.8);
    }
}

@keyframes badgePulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.8;
        transform: scale(1.1);
    }
}

/* Tablet/Desktop: maintain glass bar layout */
@media (min-width: 1024px) {
    #bottomNav > div {
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
    }
}
</style>

<script>
let lastTapTime = 0;
let lastTapTab = null;

function handleNavTap(element, event) {
    event.preventDefault();
    const now = Date.now();
    const tab = element.dataset.tab;
    
    // Double-tap detection (within 300ms)
    if (lastTapTab === tab && (now - lastTapTime) < 300) {
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        lastTapTime = 0;
        lastTapTab = null;
        return;
    }
    
    lastTapTime = now;
    lastTapTab = tab;
    
    // Haptic feedback (if available)
    if (navigator.vibrate) {
        navigator.vibrate(12);
    }
    
    // Navigate
    window.location.href = element.href;
}

           function handleCoachTap(element, event) {
               // Haptic feedback
               if (navigator.vibrate) {
                   navigator.vibrate(12);
               }
               
               // Check if we're on lesson page - open bottom sheet
               if (typeof window.openCoachSheet === 'function') {
                   window.openCoachSheet();
               } else {
                   // Otherwise navigate to AI chat
                   window.location.href = element.getAttribute('href');
               }
               
               return false;
           }

function showCoachQuickActions() {
    // TODO: Implement quick actions sheet
    console.log('Show quick actions');
}

// Check for active lesson and show resume bar
function checkActiveLesson() {
    // TODO: Check if user has active lesson
    // If yes, show resume bar above footer
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    checkActiveLesson();
    
    // Update active state based on current URL
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Set active based on route
    if (currentPath.includes('/ai-chat') || currentPath.includes('/lesson/')) {
        document.querySelector('[data-tab="coach"]')?.classList.add('active');
    } else if (currentPath.includes('/district/') && (currentPath.includes('/venues') || currentPath.includes('/venue/'))) {
        document.querySelector('[data-tab="venues"]')?.classList.add('active');
    } else if (currentPath === '/' || currentPath.startsWith('/district/')) {
        document.querySelector('[data-tab="districts"]')?.classList.add('active');
    } else if (currentPath.includes('/profile')) {
        document.querySelector('[data-tab="profile"]')?.classList.add('active');
    }
});
</script>

