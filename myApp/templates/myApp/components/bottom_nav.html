{% load app_filters %}
<div class="fixed bottom-0 left-0 right-0 z-50 safe-area-bottom" id="bottomNav">
    <!-- Glassy footer bar -->
    <div class="bg-ink-surface/80 backdrop-blur-md border-t border-default h-16 sm:h-18">
        <div class="max-w-7xl mx-auto h-full flex items-center justify-around px-2 sm:px-4">
            
            <!-- [A] Home / Map -->
            <a href="{% if user.profile.ab_variant == 'B' %}{% url 'district_map' 1 %}{% else %}{% url 'home' %}{% endif %}" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'home' or request.resolver_match.url_name == 'district_map' %}active{% endif %}"
               data-tab="home"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    {% if user.profile.ab_variant == 'B' %}
                        <!-- Map icon -->
                        <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                    {% else %}
                        <!-- Home icon -->
                        <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                        </svg>
                    {% endif %}
                    <!-- Streak badge -->
                    {% if user.profile.current_streak > 0 %}
                    <span class="absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full flex items-center justify-center text-xs">ðŸ”¥</span>
                    {% endif %}
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">{% if user.profile.ab_variant == 'B' %}Map{% else %}Home{% endif %}</span>
            </a>
            
            <!-- [B] Learn -->
            <a href="{% url 'home' %}" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if 'lesson' in request.resolver_match.url_name or 'milestone' in request.resolver_match.url_name %}active{% endif %}"
               data-tab="learn"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    <!-- Quest badge -->
                    {% if daily_quest and not daily_quest.completed %}
                    <span class="absolute -top-1 -right-1 w-4 h-4 bg-cyan rounded-full flex items-center justify-center text-[8px] font-bold">!</span>
                    {% endif %}
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">Learn</span>
            </a>
            
               <!-- [C] Coach (Center Action) -->
               <a href="#" 
                  class="nav-tab coach-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'lesson_runner' or request.resolver_match.url_name == 'ai_chat' %}active{% endif %}"
                  data-tab="coach"
                  onclick="handleCoachTap(this, event); return false;">
                <div class="relative">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-electric-violet to-purple-600 flex items-center justify-center shadow-lg shadow-electric-violet/50 coach-glow">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                    </div>
                    <!-- AI tip badge -->
                    <span class="absolute -top-1 -right-1 w-4 h-4 bg-cyan rounded-full flex items-center justify-center text-[8px] font-bold coach-badge hidden">ðŸ’¡</span>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5 hidden sm:block">Coach</span>
            </a>
            
            <!-- [D] District -->
            <a href="{% url 'district_map' 1 %}" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'district_map' or request.resolver_match.url_name == 'venue_detail' %}active{% endif %}"
               data-tab="district"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    {% if user.profile.district_1_unlocked %}
                        <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    {% else %}
                        <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                    {% endif %}
                    <!-- Ticket badge -->
                    {% if user.profile.tickets > 0 %}
                    <span class="absolute -top-1 -right-1 min-w-[16px] h-4 bg-electric-violet rounded-full flex items-center justify-center text-[8px] font-bold px-1">ðŸŽŸ{{ user.profile.tickets }}</span>
                    {% endif %}
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">District</span>
            </a>
            
            <!-- [E] Me -->
            <a href="{% url 'profile' %}" 
               class="nav-tab flex flex-col items-center justify-center relative flex-1 h-full transition-all duration-200 ease-out {% if request.resolver_match.url_name == 'profile' %}active{% endif %}"
               data-tab="me"
               onclick="handleNavTap(this, event)">
                <div class="relative">
                    <svg class="w-6 h-6 nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <!-- New reward dot -->
                    <div class="absolute -top-1 -right-1 w-2 h-2 bg-cyan rounded-full me-dot hidden"></div>
                    <!-- Active indicator -->
                    <div class="absolute -top-0.5 left-1/2 -translate-x-1/2 w-8 h-0.5 bg-electric-violet rounded-full nav-indicator hidden"></div>
                </div>
                <span class="nav-label text-[10px] sm:text-[11px] font-medium mt-0.5">Me</span>
            </a>
            
        </div>
    </div>
</div>

<style>
/* Safe area for devices with home indicator */
.safe-area-bottom {
    padding-bottom: env(safe-area-inset-bottom, 0);
}

/* Nav tab states */
.nav-tab {
    color: rgba(255, 255, 255, 0.7);
    transform: scale(1);
}

.nav-tab:active {
    transform: scale(0.98);
    transition: transform 120ms;
}

.nav-tab.active {
    color: #8b5cf6; /* electric-violet */
}

.nav-tab.active .nav-icon {
    color: #8b5cf6;
}

.nav-tab.active .nav-indicator {
    display: block;
    animation: slideIn 200ms ease-out;
}

.nav-label {
    color: inherit;
    opacity: 0.7;
}

.nav-tab.active .nav-label {
    opacity: 1;
    color: #8b5cf6;
}

[data-theme="light"] .nav-tab {
    color: rgba(15, 23, 42, 0.65);
}

[data-theme="light"] .nav-tab.active {
    color: var(--color-electric-violet);
}

[data-theme="light"] .nav-tab.active .nav-icon {
    color: var(--color-electric-violet);
}

[data-theme="light"] .nav-label {
    color: rgba(15, 23, 42, 0.65);
}

[data-theme="light"] .nav-tab.active .nav-label {
    color: var(--color-electric-violet);
    opacity: 1;
}

[data-theme="light"] #bottomNav > div {
    background-color: rgba(255, 255, 255, 0.95);
    border-color: var(--color-border-default);
    box-shadow: 0 -4px 18px rgba(15, 23, 42, 0.08);
}

/* Coach center action */
.coach-tab {
    margin-top: -8px;
}

.coach-glow {
    animation: coachPulse 3s ease-in-out infinite;
}

.coach-badge {
    animation: badgePulse 2s ease-in-out infinite;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(-50%) scaleX(0);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) scaleX(1);
    }
}

@keyframes coachPulse {
    0%, 100% {
        box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
    }
    50% {
        box-shadow: 0 0 30px rgba(139, 92, 246, 0.8);
    }
}

@keyframes badgePulse {
    0%, 100% {
        opacity: 1;
        transform: scale(1);
    }
    50% {
        opacity: 0.8;
        transform: scale(1.1);
    }
}

/* Tablet/Desktop: Side dock */
@media (min-width: 768px) {
    #bottomNav {
        top: 0;
        bottom: auto;
        left: 0;
        width: 80px;
        height: 100vh;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        border-top: none;
    }
    
    #bottomNav > div {
        flex-direction: column;
        height: 100%;
        justify-content: flex-start;
        padding-top: 2rem;
        gap: 2rem;
    }
    
    .coach-tab {
        margin-top: auto;
        margin-bottom: 2rem;
    }
    
    .nav-label {
        display: block !important;
    }
}
</style>

<script>
let lastTapTime = 0;
let lastTapTab = null;

function handleNavTap(element, event) {
    event.preventDefault();
    const now = Date.now();
    const tab = element.dataset.tab;
    
    // Double-tap detection (within 300ms)
    if (lastTapTab === tab && (now - lastTapTime) < 300) {
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
        lastTapTime = 0;
        lastTapTab = null;
        return;
    }
    
    lastTapTime = now;
    lastTapTab = tab;
    
    // Haptic feedback (if available)
    if (navigator.vibrate) {
        navigator.vibrate(12);
    }
    
    // Navigate
    window.location.href = element.href;
}

           function handleCoachTap(element, event) {
               // Haptic feedback
               if (navigator.vibrate) {
                   navigator.vibrate(12);
               }
               
               // Check if we're on lesson page - open bottom sheet
               if (typeof window.openCoachSheet === 'function') {
                   window.openCoachSheet();
               } else {
                   // Otherwise navigate to AI chat
                   window.location.href = '{% url "ai_chat" %}';
               }
               
               return false;
           }

function showCoachQuickActions() {
    // TODO: Implement quick actions sheet
    console.log('Show quick actions');
}

// Check for active lesson and show resume bar
function checkActiveLesson() {
    // TODO: Check if user has active lesson
    // If yes, show resume bar above footer
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    checkActiveLesson();
    
    // Update active state based on current URL
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Set active based on route
    if (currentPath === '/' || currentPath.startsWith('/district/')) {
        document.querySelector('[data-tab="home"]')?.classList.add('active');
    } else if (currentPath.includes('/lesson/') || currentPath.includes('/milestone/')) {
        document.querySelector('[data-tab="learn"]')?.classList.add('active');
    } else if (currentPath.includes('/district/')) {
        document.querySelector('[data-tab="district"]')?.classList.add('active');
    } else if (currentPath.includes('/profile')) {
        document.querySelector('[data-tab="me"]')?.classList.add('active');
    }
});
</script>

